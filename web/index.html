<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RUIAN Map Viewer</title>

    <!-- MapLibre GL JS -->
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Layer control panel */
        .layer-control {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            min-width: 200px;
        }

        .layer-control h3 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .layer-control label {
            display: flex;
            align-items: center;
            margin: 6px 0;
            cursor: pointer;
            font-size: 13px;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        .layer-color {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-right: 6px;
            border-radius: 2px;
            border: 1px solid #ccc;
        }

        /* Popup styling */
        .maplibregl-popup-content {
            padding: 12px;
            max-width: 300px;
            font-size: 13px;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
        }

        .popup-content {
            max-height: 200px;
            overflow-y: auto;
        }

        .popup-content table {
            width: 100%;
            border-collapse: collapse;
        }

        .popup-content td {
            padding: 3px 0;
            vertical-align: top;
        }

        .popup-content td:first-child {
            color: #666;
            padding-right: 10px;
            white-space: nowrap;
        }

        /* Loading indicator */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 2000;
        }

        .loading.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="loading" id="loading">Loading map...</div>

    <div class="layer-control">
        <h3>Base Layer</h3>

        <label>
            <input type="checkbox" id="toggle-osm" checked>
            <span class="layer-color" style="background: linear-gradient(135deg, #f0e68c 25%, #90ee90 50%, #add8e6 75%);"></span>
            OpenStreetMap
        </label>

        <h3 style="margin-top: 12px;">RUIAN Layers</h3>

        <label>
            <input type="checkbox" id="toggle-adresnimista" checked>
            <span class="layer-color" style="background: #e74c3c;"></span>
            Address Points
        </label>

        <label>
            <input type="checkbox" id="toggle-stavebniobjekty" checked>
            <span class="layer-color" style="background: rgba(52, 152, 219, 0.5); border-color: #2980b9;"></span>
            Buildings
        </label>

        <label>
            <input type="checkbox" id="toggle-parcely">
            <span class="layer-color" style="background: transparent; border-color: #27ae60;"></span>
            Parcels
        </label>

        <label>
            <input type="checkbox" id="toggle-ulice" checked>
            <span class="layer-color" style="background: #7f8c8d;"></span>
            Streets
        </label>

        <label>
            <input type="checkbox" id="toggle-obce" checked>
            <span class="layer-color" style="background: transparent; border-color: #e67e22;"></span>
            Municipalities
        </label>

        <label>
            <input type="checkbox" id="toggle-katastralniuzemi">
            <span class="layer-color" style="background: transparent; border-color: #9b59b6;"></span>
            Cadastral Areas
        </label>

        <label>
            <input type="checkbox" id="toggle-okresy">
            <span class="layer-color" style="background: transparent; border-color: #1abc9c;"></span>
            Districts
        </label>

        <h3 style="margin-top: 12px;">Document References</h3>

        <label>
            <input type="checkbox" id="toggle-parcels_with_documents" checked>
            <span class="layer-color" style="background: rgba(255, 0, 0, 0.4); border-color: #ff0000;"></span>
            Parcels with Docs
        </label>

        <label>
            <input type="checkbox" id="toggle-addresses_with_documents" checked>
            <span class="layer-color" style="background: #ff00ff;"></span>
            Addresses with Docs
        </label>

        <label>
            <input type="checkbox" id="toggle-streets_with_documents" checked>
            <span class="layer-color" style="background: #ff6600;"></span>
            Streets with Docs
        </label>

        <label>
            <input type="checkbox" id="toggle-buildings_with_documents" checked>
            <span class="layer-color" style="background: rgba(0, 200, 255, 0.5); border-color: #00a0cc;"></span>
            Buildings with Docs
        </label>
    </div>

    <script>
        // Configuration - change TILE_SERVER_URL for production
        const CONFIG = {
            // For local development
            TILE_SERVER_URL: 'http://localhost:3000',
            // For production (uncomment and adjust)
            // TILE_SERVER_URL: 'http://46.224.67.103:3000',

            // Initial map center (Brno - sample data location)
            CENTER: [16.59, 49.21],
            ZOOM: 10,
            MIN_ZOOM: 6,
            MAX_ZOOM: 20
        };

        // Layer definitions with styles
        const LAYERS = {
            adresnimista: {
                type: 'circle',
                minzoom: 14,
                paint: {
                    'circle-radius': [
                        'interpolate', ['linear'], ['zoom'],
                        14, 2,
                        18, 6
                    ],
                    'circle-color': '#e74c3c',
                    'circle-stroke-color': '#c0392b',
                    'circle-stroke-width': 1
                }
            },
            stavebniobjekty: {
                type: 'fill',
                minzoom: 13,
                paint: {
                    'fill-color': '#3498db',
                    'fill-opacity': 0.5,
                    'fill-outline-color': '#2980b9'
                }
            },
            parcely: {
                type: 'line',
                minzoom: 15,
                paint: {
                    'line-color': '#27ae60',
                    'line-width': 1,
                    'line-opacity': 0.8
                }
            },
            ulice: {
                type: 'line',
                minzoom: 12,
                paint: {
                    'line-color': '#7f8c8d',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        12, 1,
                        16, 3
                    ]
                }
            },
            obce: {
                type: 'line',
                minzoom: 8,
                maxzoom: 14,
                paint: {
                    'line-color': '#e67e22',
                    'line-width': 2,
                    'line-dasharray': [2, 2]
                }
            },
            katastralniuzemi: {
                type: 'line',
                minzoom: 12,
                paint: {
                    'line-color': '#9b59b6',
                    'line-width': 1.5,
                    'line-dasharray': [4, 2]
                }
            },
            okresy: {
                type: 'line',
                minzoom: 6,
                maxzoom: 12,
                paint: {
                    'line-color': '#1abc9c',
                    'line-width': 2
                }
            },
            // Document reference layers
            parcels_with_documents: {
                type: 'fill',
                minzoom: 14,
                paint: {
                    'fill-color': '#ff0000',
                    'fill-opacity': 0.4,
                    'fill-outline-color': '#cc0000'
                }
            },
            addresses_with_documents: {
                type: 'circle',
                minzoom: 13,
                paint: {
                    'circle-radius': [
                        'interpolate', ['linear'], ['zoom'],
                        13, 4,
                        18, 10
                    ],
                    'circle-color': '#ff00ff',
                    'circle-stroke-color': '#cc00cc',
                    'circle-stroke-width': 2
                }
            },
            streets_with_documents: {
                type: 'line',
                minzoom: 12,
                paint: {
                    'line-color': '#ff6600',
                    'line-width': [
                        'interpolate', ['linear'], ['zoom'],
                        12, 3,
                        16, 6
                    ]
                }
            },
            buildings_with_documents: {
                type: 'fill',
                minzoom: 13,
                paint: {
                    'fill-color': '#00c8ff',
                    'fill-opacity': 0.5,
                    'fill-outline-color': '#00a0cc'
                }
            }
        };

        // Property labels for popup display
        const PROPERTY_LABELS = {
            kod: 'Code',
            nazev: 'Name',
            cislodomovni: 'House number',
            cisloorientacni: 'Orientation number',
            cisloorientacnipismeno: 'Letter',
            psc: 'ZIP code',
            pocetpodlazi: 'Floors',
            pocetbytu: 'Apartments',
            zastavenaplocha: 'Built-up area (m²)',
            vymeraparcely: 'Parcel area (m²)',
            kmenovecislo: 'Parcel number',
            pododdelenicisla: 'Sub-number',
            obeckod: 'Municipality code',
            okreskod: 'District code',
            // Document reference properties
            parcel_number: 'Parcel number',
            parcel_sub_number: 'Sub-number',
            house_number: 'House number',
            orientation_number: 'Orientation number',
            street_name: 'Street name',
            document_id: 'Document ID',
            document_title: 'Document title',
            document_type: 'Document type',
            ref_type: 'Reference type',
            confidence: 'Confidence'
        };

        // Layer display names for popups
        const LAYER_NAMES = {
            adresnimista: 'Address Point',
            stavebniobjekty: 'Building',
            parcely: 'Parcel',
            ulice: 'Street',
            obce: 'Municipality',
            katastralniuzemi: 'Cadastral Area',
            okresy: 'District',
            parcels_with_documents: 'Parcel with Document',
            addresses_with_documents: 'Address with Document',
            streets_with_documents: 'Street with Document',
            buildings_with_documents: 'Building with Document'
        };

        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    osm: {
                        type: 'raster',
                        tiles: [
                            'https://tile.openstreetmap.org/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }
                },
                layers: [
                    {
                        id: 'osm-tiles',
                        type: 'raster',
                        source: 'osm',
                        minzoom: 0,
                        maxzoom: 19
                    }
                ]
            },
            center: CONFIG.CENTER,
            zoom: CONFIG.ZOOM,
            minZoom: CONFIG.MIN_ZOOM,
            maxZoom: CONFIG.MAX_ZOOM
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-left');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        // Popup instance
        const popup = new maplibregl.Popup({
            closeButton: true,
            closeOnClick: true,
            maxWidth: '320px'
        });

        // Format property value for display
        function formatValue(key, value) {
            if (value === null || value === undefined) return '-';
            if (Array.isArray(value)) return value.join(', ');
            if (key === 'vymeraparcely' || key === 'zastavenaplocha') {
                return value.toLocaleString('cs-CZ');
            }
            return value;
        }

        // Generate popup HTML content
        function generatePopupContent(layerId, properties) {
            const layerName = LAYER_NAMES[layerId] || layerId;
            let html = `<div class="popup-title">${layerName}</div>`;
            html += '<div class="popup-content"><table>';

            for (const [key, value] of Object.entries(properties)) {
                // Skip internal/technical fields
                if (key === 'ogc_fid' || key === 'gml_id' || key.includes('transakce')) continue;

                const label = PROPERTY_LABELS[key] || key;
                const displayValue = formatValue(key, value);
                html += `<tr><td>${label}:</td><td>${displayValue}</td></tr>`;
            }

            html += '</table></div>';
            return html;
        }

        // Handle feature click
        function handleFeatureClick(e, layerId) {
            if (!e.features || e.features.length === 0) return;

            const feature = e.features[0];
            const coordinates = e.lngLat;

            popup
                .setLngLat(coordinates)
                .setHTML(generatePopupContent(layerId, feature.properties))
                .addTo(map);
        }

        // Add RUIAN layers when map loads
        map.on('load', () => {
            document.getElementById('loading').classList.add('hidden');

            // Add layers in order (bottom to top)
            const layerOrder = ['okresy', 'obce', 'katastralniuzemi', 'parcely', 'ulice', 'stavebniobjekty', 'adresnimista', 'parcels_with_documents', 'buildings_with_documents', 'streets_with_documents', 'addresses_with_documents'];

            for (const layerId of layerOrder) {
                const layerConfig = LAYERS[layerId];

                // Add source for each layer (Martin serves each table separately)
                map.addSource(layerId, {
                    type: 'vector',
                    tiles: [
                        `${CONFIG.TILE_SERVER_URL}/${layerId}/{z}/{x}/{y}`
                    ],
                    minzoom: 6,
                    maxzoom: 20
                });

                // Create layer definition
                const layerDef = {
                    id: layerId,
                    type: layerConfig.type,
                    source: layerId,
                    'source-layer': layerId,
                    paint: layerConfig.paint
                };

                if (layerConfig.minzoom) layerDef.minzoom = layerConfig.minzoom;
                if (layerConfig.maxzoom) layerDef.maxzoom = layerConfig.maxzoom;

                map.addLayer(layerDef);

                // Set initial visibility based on checkbox state
                const checkbox = document.getElementById(`toggle-${layerId}`);
                if (checkbox && !checkbox.checked) {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                }

                // Add click handler
                map.on('click', layerId, (e) => handleFeatureClick(e, layerId));

                // Change cursor on hover
                map.on('mouseenter', layerId, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', layerId, () => {
                    map.getCanvas().style.cursor = '';
                });
            }

            // Wire up layer toggle checkboxes
            for (const layerId of Object.keys(LAYERS)) {
                const checkbox = document.getElementById(`toggle-${layerId}`);
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        const visibility = e.target.checked ? 'visible' : 'none';
                        map.setLayoutProperty(layerId, 'visibility', visibility);
                    });
                }
            }

            // Wire up OSM base layer toggle
            const osmCheckbox = document.getElementById('toggle-osm');
            if (osmCheckbox) {
                osmCheckbox.addEventListener('change', (e) => {
                    const visibility = e.target.checked ? 'visible' : 'none';
                    map.setLayoutProperty('osm-tiles', 'visibility', visibility);
                });
            }
        });

        // Handle map load errors
        map.on('error', (e) => {
            console.error('Map error:', e.error);
            if (e.error && e.error.message && e.error.message.includes('Failed to fetch')) {
                document.getElementById('loading').textContent =
                    'Failed to load tiles. Make sure Martin tile server is running on ' + CONFIG.TILE_SERVER_URL;
                document.getElementById('loading').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
